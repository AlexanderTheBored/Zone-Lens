<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ZoneGuide – Mandaue Flood Risk Analysis</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
  body { margin:0; padding:0; font-family:system-ui,sans-serif; background:#000; color:#fff; }
  #map { position:absolute; top:0; bottom:0; width:100%; }

  .controls{
    position:absolute; top:20px; left:20px;
    background:rgba(10,10,10,0.95);
    border:1px solid #333;
    padding:20px; width:280px; z-index:10;
    border-radius:8px;
  }
  .controls h3{
    margin:0 0 15px 0; font-size:14px; text-transform:uppercase; letter-spacing:1px;
    color:#888; border-bottom:1px solid #333; padding-bottom:10px;
  }
  .filter-btn{
    display:block; width:100%;
    padding:12px; margin-bottom:8px;
    background:transparent; border:1px solid #444;
    color:#ccc; cursor:pointer; font-size:13px; text-align:left; text-transform:uppercase;
    border-radius:4px; transition:all 0.2s;
  }
  .filter-btn:hover{ border-color:#fff; color:#fff; }
  .filter-btn.active{ background:#fff; color:#000; border-color:#fff; font-weight:bold; }

  .legend{
    position:absolute; bottom:30px; right:20px;
    background:rgba(0,0,0,0.9);
    border:1px solid #333;
    padding:15px; font-size:12px;
    border-radius:8px;
  }
  .legend h4{
    margin:0 0 10px 0; font-size:12px; text-transform:uppercase; 
    color:#888; border-bottom:1px solid #333; padding-bottom:8px;
  }
  .legend-item{ display:flex; align-items:center; margin-bottom:8px; }
  .color-box{ width:14px; height:14px; margin-right:10px; border:1px solid #555; border-radius:2px; }

  .elevation-controls{
    position:absolute; top:20px; right:20px;
    background:rgba(10,10,10,0.95);
    border:1px solid #333;
    padding:15px; width:240px; z-index:10;
    border-radius:8px;
  }
  .elevation-controls h3{
    margin:0 0 10px 0; font-size:13px; text-transform:uppercase; letter-spacing:1px;
    color:#888; border-bottom:1px solid #333; padding-bottom:8px;
  }
  .toggle-btn{
    display:block; width:100%;
    padding:10px; margin-bottom:8px;
    background:transparent; border:1px solid #444;
    color:#ccc; cursor:pointer; font-size:12px; text-align:center;
    border-radius:4px; transition:all 0.2s;
  }
  .toggle-btn:hover{ border-color:#fff; color:#fff; }
  .toggle-btn.active{ background:#ef4444; color:#fff; border-color:#ef4444; font-weight:bold; }

  .search-box{
    position:absolute; top:20px; left:50%; transform:translateX(-50%);
    background:#ffffff;
    border:none;
    padding:0;
    width:500px; 
    z-index:1000;
    border-radius:10px;
    box-shadow:0 4px 20px rgba(0,0,0,0.4);
  }
  .search-input{
    width:100%; 
    padding:16px 20px;
    background:#ffffff; 
    border:none;
    color:#1f2937; 
    font-size:16px;
    border-radius:10px;
    outline:none;
    font-family:system-ui,sans-serif;
    box-shadow:none;
  }
  .search-input::placeholder{ color:#9ca3af; }
  .search-input:focus{ 
    outline:3px solid #3b82f6; 
    outline-offset:-3px;
  }
  .search-results{
    background:#ffffff;
    border-radius:0 0 10px 10px;
    max-height:350px; 
    overflow-y:auto;
    margin:0;
    padding:0;
  }
  .search-result-item{
    padding:14px 20px; 
    background:#ffffff; 
    border:none;
    border-top:1px solid #e5e7eb;
    margin:0; 
    cursor:pointer;
    transition:all 0.15s;
  }
  .search-result-item:first-child{ border-top:none; }
  .search-result-item:last-child{ border-radius:0 0 10px 10px; }
  .search-result-item:hover{ 
    background:#f3f4f6; 
  }
  .search-result-title{ 
    color:#1f2937; 
    font-weight:600; 
    font-size:15px; 
    margin:0;
    padding:0;
  }
  .search-result-address{ 
    color:#6b7280; 
    font-size:13px; 
    margin-top:4px; 
    padding:0;
  }
</style>
</head>

<body>
<div id="map"></div>

<div class="search-box">
  <input 
    type="text" 
    id="searchInput" 
    class="search-input" 
    placeholder="Search for address, building, or place in Mandaue..."
  >
  <div id="searchResults" class="search-results"></div>
</div>

<div class="controls">
  <h3>Project Filter</h3>
  <button class="filter-btn active" data-filter="all">View All Zones</button>
  <button class="filter-btn" data-filter="house">Residential Project</button>
  <button class="filter-btn" data-filter="factory">Industrial Facility</button>
  <button class="filter-btn" data-filter="mall">Commercial Complex</button>
</div>

<div class="legend">
  <h4>Zoning Districts</h4>
  <div class="legend-item"><span class="color-box" style="background:#facc15"></span>Residential (R-1)</div>
  <div class="legend-item"><span class="color-box" style="background:#a855f7"></span>Industrial (I-2)</div>
  <div class="legend-item"><span class="color-box" style="background:#ef4444"></span>Commercial (C-2)</div>
  
  <h4 style="margin-top:15px;">Flood Risk Zones</h4>
  <div class="legend-item"><span class="color-box" style="background:#b91c1c"></span>Critical (Roof-level)</div>
  <div class="legend-item"><span class="color-box" style="background:#dc2626"></span>High Risk (Chest-deep)</div>
  <div class="legend-item"><span class="color-box" style="background:#f59e0b"></span>Moderate (Knee-deep)</div>
  <div class="legend-item"><span class="color-box" style="background:#fbbf24"></span>Low (Street flooding)</div>
</div>

<div class="elevation-controls">
  <h3>Flood Risk Layers</h3>
  <button class="toggle-btn" id="terrainBtn">Show 3D Terrain Map</button>
  <button class="toggle-btn" id="buildingsBtn">Show 3D Buildings</button>
  <button class="toggle-btn" id="floodBtn">Show Flood Risk Zones</button>
  <button class="toggle-btn" id="riverBtn">Show Water Bodies</button>
  <button class="toggle-btn" id="contourBtn">Show Elevation Lines</button>
  <div style="margin-top:12px; font-size:11px; color:#888; line-height:1.5;">
    <strong style="color:#3b82f6;">3D Terrain:</strong> Shows actual elevation with hillshading<br>
    <strong style="color:#6b7280;">3D Buildings:</strong> Extrudes buildings to real heights<br><br>
    <strong style="color:#b91c1c;">CRITICAL zones:</strong> Roof-level flooding documented (6-9ft)<br>
    <strong style="color:#dc2626;">HIGH RISK zones:</strong> 2nd floor flooding (5-8ft)<br>
    <strong style="color:#f59e0b;">MODERATE zones:</strong> Chest/knee-deep (2-4ft)<br><br>
    <em>Data from MCDRRMO 2022-2025 flood incidents. 29,000+ evacuated in Nov 2025.</em>
  </div>
</div>

<script>
  mapboxgl.accessToken =
  'pk.eyJ1IjoiZmxhcmVpdW0iLCJhIjoiY21qaXF4eDRyMTQ5ZjNlcTF2c3Ntd3NzOSJ9.jb1Fbw5JUyvBJ2czkccBXA';

  // Updated zones with realistic flood risk based on Butuanon River proximity
  const zoningData = {
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        properties: {
          name: "Cabancalan–Canduman Residential Area",
          zone: "Residential (R-1)",
          color: "#facc15",
          allows_house: true,
          allows_mall: false,
          allows_factory: false,
          notes: "Predominantly residential barangays with low-rise housing.",
          floodRisk: "moderate"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.920, 10.360],
            [123.930, 10.365],
            [123.938, 10.362],
            [123.945, 10.355],
            [123.942, 10.345],
            [123.935, 10.342],
            [123.925, 10.345],
            [123.918, 10.352],
            [123.920, 10.360]
          ]]
        }
      },
      {
        type: "Feature",
        properties: {
          name: "A.S. Fortuna – Banilad Commercial Corridor",
          zone: "Commercial (C-2)",
          color: "#ef4444",
          allows_house: true,
          allows_mall: true,
          allows_factory: false,
          notes: "Dense commercial corridor along A.S. Fortuna Street. Prone to flooding during heavy rains.",
          floodRisk: "high"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.915, 10.348],
            [123.928, 10.350],
            [123.935, 10.345],
            [123.930, 10.335],
            [123.922, 10.332],
            [123.912, 10.335],
            [123.910, 10.342],
            [123.915, 10.348]
          ]]
        }
      },
      {
        type: "Feature",
        properties: {
          name: "Subangdaku Industrial Belt",
          zone: "Industrial (I-2)",
          color: "#a855f7",
          allows_house: false,
          allows_mall: true,
          allows_factory: true,
          notes: "Industrial zone in central-western Mandaue. High flood risk from Butuanon River overflow.",
          floodRisk: "high"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.918, 10.330],
            [123.933, 10.332],
            [123.938, 10.325],
            [123.936, 10.315],
            [123.930, 10.310],
            [123.920, 10.308],
            [123.912, 10.312],
            [123.910, 10.320],
            [123.915, 10.328],
            [123.918, 10.330]
          ]]
        }
      }
    ]
  };

  // Butuanon River path - CORRECTED to match actual geography visible in satellite/3D view
  // The river actually runs MORE TO THE EAST than previously mapped
  // TRUE SOURCE: Mountain areas of Malubog/Pulangbato → Talamban (Cebu City) → 
  // flows into Mandaue through: Banilad → Cabancalan → Casuntingan → 
  // Tingub → Maguikay → Tabok → Ibabao → Alang-alang → Paknaan → Umapad → Mactan Channel
  const butuanonRiver = {
    type: "Feature",
    properties: { name: "Butuanon River - 23km from mountains to sea" },
    geometry: {
      type: "LineString",
      coordinates: [
        // TRUE UPSTREAM: Mountain area (Pulangbato area, Cebu City) - SHIFTED EAST
        [123.900, 10.380],
        [123.905, 10.377],
        [123.910, 10.374],
        // Talamban/Bacayan area (primary watershed)
        [123.915, 10.371],
        [123.920, 10.368],
        [123.924, 10.365],
        // Banilad border (Cebu City to Mandaue transition)
        [123.928, 10.362],
        [123.931, 10.359],
        // MANDAUE CITY BEGINS - Banilad/Cabancalan area
        [123.934, 10.356],
        [123.937, 10.353],
        // Casuntingan area
        [123.939, 10.350],
        [123.941, 10.347],
        // Tingub area
        [123.943, 10.344],
        [123.944, 10.341],
        // Maguikay area
        [123.945, 10.338],
        [123.946, 10.335],
        // Tabok area
        [123.946, 10.332],
        [123.946, 10.329],
        // Ibabao-Estancia (major flood area)
        [123.945, 10.326],
        [123.944, 10.323],
        // Alang-alang
        [123.943, 10.320],
        [123.942, 10.317],
        // Paknaan (Cambogaong Bridge, Butuanon Bridge at 10.34405, 123.95884)
        [123.941, 10.314],
        [123.940, 10.311],
        // Umapad area
        [123.939, 10.308],
        [123.938, 10.305],
        // Drains to Mactan Channel
        [123.937, 10.302],
        [123.936, 10.299],
        [123.935, 10.296]
      ]
    }
  };

  // REALISTIC flood risk zones based on ACTUAL documented flooding incidents
  // Data sources: MCDRRMO reports, 2022-2025 flood events, official barangay records
  const floodRiskZones = {
    type: "FeatureCollection",
    features: [
      // CRITICAL RISK: 6 major overflow points (roof-level flooding documented)
      // Casuntingan, Maguikay, Paknaan, Umapad - worst affected barangays
      {
        type: "Feature",
        properties: { 
          risk: "critical", 
          name: "CRITICAL: Paknaan-Umapad Corridor",
          details: "Roof-level flooding documented. 190+ families evacuated. 3-meter easement violations.",
          depth: "2nd floor to roof level (6-9 feet)",
          frequency: "Every typhoon + heavy rain"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.938, 10.305],
            [123.944, 10.315],
            [123.947, 10.315],
            [123.941, 10.305],
            [123.938, 10.305]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { 
          risk: "critical", 
          name: "CRITICAL: Ibabao-Estancia Overflow Zone",
          details: "Major overflow point. Water too deep for rescue boots. Thousands evacuated.",
          depth: "Chest to 2nd floor (5-8 feet)",
          frequency: "Severe during typhoons"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.941, 10.318],
            [123.947, 10.328],
            [123.950, 10.328],
            [123.944, 10.318],
            [123.941, 10.318]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { 
          risk: "critical", 
          name: "CRITICAL: Casuntingan Riprap Area",
          details: "Damaged riprap. 675 houses destroyed in 2022. Worst flood in 30 years.",
          depth: "Waist to 2nd floor (4-8 feet)",
          frequency: "Recurring annually"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.936, 10.342],
            [123.942, 10.352],
            [123.945, 10.352],
            [123.939, 10.342],
            [123.936, 10.342]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { 
          risk: "critical", 
          name: "CRITICAL: Maguikay-Tabok Footbridge",
          details: "Official overflow point #3. Bridge area submerges regularly.",
          depth: "Waist to chest deep (3-5 feet)",
          frequency: "Every heavy rainfall"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.940, 10.332],
            [123.946, 10.342],
            [123.949, 10.342],
            [123.943, 10.332],
            [123.940, 10.332]
          ]]
        }
      },
      // HIGH RISK: Adjacent to critical zones (chest-deep flooding)
      {
        type: "Feature",
        properties: { 
          risk: "high", 
          name: "HIGH RISK: Alang-Alang Buffer",
          details: "Adjacent to overflow areas. Sitio Pulang Bukid affected.",
          depth: "Knee to waist deep (2-4 feet)",
          frequency: "During sustained rainfall"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.935, 10.308],
            [123.938, 10.305],
            [123.941, 10.305],
            [123.947, 10.315],
            [123.950, 10.315],
            [123.950, 10.318],
            [123.938, 10.318],
            [123.935, 10.308]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { 
          risk: "high", 
          name: "HIGH RISK: Tingub Extended Area",
          details: "Frequently affected. Part of 27 flood-prone barangays.",
          depth: "Ankle to knee deep (1-3 feet)",
          frequency: "Moderate to heavy rain"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.937, 10.338],
            [123.940, 10.332],
            [123.943, 10.332],
            [123.949, 10.342],
            [123.952, 10.342],
            [123.952, 10.345],
            [123.940, 10.345],
            [123.937, 10.338]
          ]]
        }
      },
      // MODERATE RISK: Secondary flooding zones (knee-deep during extreme events)
      {
        type: "Feature",
        properties: { 
          risk: "moderate", 
          name: "MODERATE: Banilad-A.S. Fortuna Area",
          details: "M. Cuenco Ave drainage issues. Waist-deep flooding reported at Rolling Hills area.",
          depth: "Street flooding to knee-deep (6 inches - 2 feet)",
          frequency: "Heavy downpours"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.930, 10.350],
            [123.936, 10.360],
            [123.945, 10.360],
            [123.945, 10.350],
            [123.930, 10.350]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { 
          risk: "moderate", 
          name: "MODERATE: Cabancalan-Canduman Zone",
          details: "Talamban mini dam helps mitigate. Some runoff during extreme weather.",
          depth: "Street flooding (3-12 inches)",
          frequency: "Extreme weather events only"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.925, 10.352],
            [123.930, 10.365],
            [123.940, 10.365],
            [123.935, 10.352],
            [123.925, 10.352]
          ]]
        }
      },
      // LOW RISK: Historically safe areas (minimal flooding)
      {
        type: "Feature",
        properties: { 
          risk: "low", 
          name: "LOW RISK: Elevated Eastern Areas",
          details: "Higher ground. Not typically affected except during unprecedented rainfall.",
          depth: "Minor street flooding only (<6 inches)",
          frequency: "Rare"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.950, 10.295],
            [123.955, 10.295],
            [123.955, 10.365],
            [123.950, 10.365],
            [123.950, 10.295]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { 
          risk: "low", 
          name: "LOW RISK: Western Periphery",
          details: "Further from river overflow zones. Generally safe.",
          depth: "Minimal (<3 inches)",
          frequency: "Very rare"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.920, 10.295],
            [123.935, 10.295],
            [123.935, 10.365],
            [123.920, 10.365],
            [123.920, 10.295]
          ]]
        }
      }
    ]
  };

  let currentData = JSON.parse(JSON.stringify(zoningData));

  function computeBoundsFromGeoJSON(fc) {
    const bounds = new mapboxgl.LngLatBounds();
    fc.features.forEach(f => {
      const coords = f.geometry.coordinates[0];
      coords.forEach(([lng, lat]) => bounds.extend([lng, lat]));
    });
    return bounds;
  }

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [123.93, 10.33],
    zoom: 12.5
  });

  map.on('load', () => {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    let searchMarker = null;

    searchInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim();
      
      if (query.length < 3) {
        searchResults.innerHTML = '';
        return;
      }

      try {
        // Mapbox Geocoding API - search for buildings, POIs, addresses
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
          `proximity=123.93,10.33&` + // Prioritize results near Mandaue
          `bbox=123.85,10.25,124.00,10.40&` + // Expanded bbox for better results
          `types=poi,address,place&` + // Include POIs (buildings), addresses, places
          `limit=8&` +
          `country=PH&` + // Limit to Philippines
          `access_token=${mapboxgl.accessToken}`
        );
        
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          searchResults.innerHTML = data.features.map(feature => {
            // Get more detailed info
            const name = feature.text || feature.place_name;
            const category = feature.properties?.category || '';
            const address = feature.place_name;
            
            return `
            <div class="search-result-item" data-lng="${feature.center[0]}" data-lat="${feature.center[1]}">
              <div class="search-result-title">${name}${category ? ' · ' + category : ''}</div>
              <div class="search-result-address">${address}</div>
            </div>
          `;
          }).join('');

          // Add click handlers to results
          document.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
              const lng = parseFloat(item.dataset.lng);
              const lat = parseFloat(item.dataset.lat);
              
              // Remove old marker if exists
              if (searchMarker) searchMarker.remove();
              
              // Add new marker
              searchMarker = new mapboxgl.Marker({ color: '#3b82f6' })
                .setLngLat([lng, lat])
                .addTo(map);
              
              // Fly to location
              map.flyTo({
                center: [lng, lat],
                zoom: 16,
                duration: 1500
              });
              
              // Clear search
              searchInput.value = item.querySelector('.search-result-title').textContent;
              searchResults.innerHTML = '';
            });
          });
        } else {
          searchResults.innerHTML = '<div style="padding:16px 20px; color:#6b7280; font-size:14px; text-align:center; background:#fff;">No results found in Mandaue</div>';
        }
      } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div style="padding:16px 20px; color:#ef4444; font-size:14px; text-align:center; background:#fff;">Search failed. Try again.</div>';
      }
    });

    // Add terrain source for 3D elevation
    map.addSource('mapbox-dem', {
      type: 'raster-dem',
      url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
      tileSize: 512,
      maxzoom: 14
    });

    // Add hillshade layer for terrain visualization
    map.addLayer({
      id: 'hillshade',
      type: 'hillshade',
      source: 'mapbox-dem',
      layout: { visibility: 'none' },
      paint: {
        'hillshade-exaggeration': 1.5,
        'hillshade-shadow-color': '#000000',
        'hillshade-highlight-color': '#ffffff',
        'hillshade-illumination-direction': 315
      }
    }, 'flood-risk-fill');

    // Add 3D Buildings layer (uses Mapbox's building data)
    map.addLayer({
      id: '3d-buildings',
      source: 'composite',
      'source-layer': 'building',
      filter: ['==', 'extrude', 'true'],
      type: 'fill-extrusion',
      minzoom: 14,
      layout: { visibility: 'none' },
      paint: {
        'fill-extrusion-color': [
          'case',
          ['boolean', ['feature-state', 'hover'], false],
          '#38bdf8',
          '#6b7280'
        ],
        'fill-extrusion-height': [
          'interpolate',
          ['linear'],
          ['zoom'],
          14, 0,
          14.5, ['get', 'height']
        ],
        'fill-extrusion-base': [
          'interpolate',
          ['linear'],
          ['zoom'],
          14, 0,
          14.5, ['get', 'min_height']
        ],
        'fill-extrusion-opacity': 0.7
      }
    });

    // Add REAL waterway data from Mapbox's built-in layers
    // This uses Mapbox's water layer which includes rivers, streams, canals
    map.addLayer({
      id: 'mapbox-waterways',
      type: 'line',
      source: 'composite',
      'source-layer': 'waterway',
      layout: { visibility: 'none' },
      paint: {
        'line-color': '#1e40af',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          11, ['case', ['==', ['get', 'class'], 'river'], 4, 2],
          13, ['case', ['==', ['get', 'class'], 'river'], 10, 4],
          15, ['case', ['==', ['get', 'class'], 'river'], 18, 8],
          17, ['case', ['==', ['get', 'class'], 'river'], 36, 14]
        ],
        'line-opacity': 0.85
      }
    });

    // Add glow effect for waterways
    map.addLayer({
      id: 'mapbox-waterways-glow',
      type: 'line',
      source: 'composite',
      'source-layer': 'waterway',
      layout: { visibility: 'none' },
      paint: {
        'line-color': '#3b82f6',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          11, ['case', ['==', ['get', 'class'], 'river'], 10, 6],
          13, ['case', ['==', ['get', 'class'], 'river'], 24, 12],
          15, ['case', ['==', ['get', 'class'], 'river'], 44, 20],
          17, ['case', ['==', ['get', 'class'], 'river'], 68, 32]
        ],
        'line-opacity': 0.25,
        'line-blur': 8
      }
    }, 'mapbox-waterways');

    // Also add water bodies (lakes, ponds)
    map.addLayer({
      id: 'mapbox-water-bodies',
      type: 'fill',
      source: 'composite',
      'source-layer': 'water',
      layout: { visibility: 'none' },
      paint: {
        'fill-color': '#1e40af',
        'fill-opacity': 0.5
      }
    });

    // Add flood risk zones layer (initially hidden)
    map.addSource('flood-risk', {
      type: 'geojson',
      data: floodRiskZones
    });

    map.addLayer({
      id: 'flood-risk-fill',
      type: 'fill',
      source: 'flood-risk',
      layout: { visibility: 'none' },
      paint: {
        'fill-color': [
          'match',
          ['get', 'risk'],
          'critical', '#b91c1c',
          'high', '#dc2626',
          'moderate', '#f59e0b',
          'low', '#fbbf24',
          '#888888'
        ],
        'fill-opacity': 0.5
      }
    });

    map.addLayer({
      id: 'flood-risk-outline',
      type: 'line',
      source: 'flood-risk',
      layout: { visibility: 'none' },
      paint: {
        'line-color': [
          'match',
          ['get', 'risk'],
          'critical', '#b91c1c',
          'high', '#dc2626',
          'moderate', '#f59e0b',
          'low', '#fbbf24',
          '#888888'
        ],
        'line-width': 1.5,
        'line-opacity': 0.7
      }
    });

    // Add Butuanon River layer (initially hidden)
    map.addSource('butuanon-river', {
      type: 'geojson',
      data: butuanonRiver
    });

    map.addLayer({
      id: 'river-line',
      type: 'line',
      source: 'butuanon-river',
      layout: { visibility: 'none' },
      paint: {
        'line-color': '#1e40af',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          11, 3,    // At zoom 11, river is 3px (smaller view)
          13, 8,    // At zoom 13, river is 8px (medium view)
          15, 16,   // At zoom 15, river is 16px (closer view - shows ~15-20m width)
          17, 32    // At zoom 17, river is 32px (very close - shows full width)
        ],
        'line-opacity': 0.85
      }
    });

    map.addLayer({
      id: 'river-glow',
      type: 'line',
      source: 'butuanon-river',
      layout: { visibility: 'none' },
      paint: {
        'line-color': '#3b82f6',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          11, 8,
          13, 20,
          15, 40,
          17, 60
        ],
        'line-opacity': 0.25,
        'line-blur': 8
      }
    });

    // Add zoning layers
    map.addSource('zones', { type: 'geojson', data: currentData });

    map.addLayer({
      id: 'zones-fill',
      type: 'fill',
      source: 'zones',
      paint: {
        'fill-color': ['get', 'color'],
        'fill-opacity': 0.5
      }
    });

    map.addLayer({
      id: 'zones-outline',
      type: 'line',
      source: 'zones',
      paint: {
        'line-color': '#ffffff',
        'line-width': 2,
        'line-opacity': 0.6
      }
    });

    // Cursor UX
    map.on('mouseenter', 'zones-fill', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'zones-fill', () => map.getCanvas().style.cursor = '');

    // Fit to zones on load
    map.fitBounds(computeBoundsFromGeoJSON(currentData), { padding: 80, duration: 0 });

    // Click popup for zones
    map.on('click', 'zones-fill', (e) => {
      const f = e.features && e.features[0];
      if (!f) return;

      const p = f.properties || {};
      const name = p.name ?? "Unnamed Zone";
      const zone = p.zone ?? "Unknown Zone";
      const notes = p.notes ?? "";
      const floodRisk = p.floodRisk ?? "unknown";
      
      const riskColor = floodRisk === 'high' ? '#dc2626' : 
                        floodRisk === 'moderate' ? '#f59e0b' : '#22c55e';
      const riskText = floodRisk === 'high' ? 'HIGH RISK' : 
                       floodRisk === 'moderate' ? 'MODERATE RISK' : 'LOW RISK';

      new mapboxgl.Popup({ closeButton: true, closeOnClick: true })
        .setLngLat(e.lngLat)
        .setHTML(`
          <div style="color:#111; font-family:system-ui,sans-serif; font-size:13px;">
            <strong>${name}</strong><br>
            <span style="color:#666;">Zone: ${zone}</span><br>
            <div style="margin:8px 0; padding:6px; background:${riskColor}; color:#fff; border-radius:4px; text-align:center; font-weight:bold; font-size:11px;">
              FLOOD RISK: ${riskText}
            </div>
            <small style="color:#666;">${notes}</small>
          </div>
        `)
        .addTo(map);
    });

    // Click popup for flood zones
    map.on('click', 'flood-risk-fill', (e) => {
      const f = e.features && e.features[0];
      if (!f) return;

      const risk = f.properties.risk;
      const riskColor = risk === 'critical' ? '#b91c1c' :
                        risk === 'high' ? '#dc2626' : 
                        risk === 'moderate' ? '#f59e0b' : '#fbbf24';
      const riskLabel = risk === 'critical' ? 'CRITICAL' :
                        risk === 'high' ? 'HIGH' :
                        risk === 'moderate' ? 'MODERATE' : 'LOW';

      new mapboxgl.Popup({ closeButton: true, closeOnClick: true })
        .setLngLat(e.lngLat)
        .setHTML(`
          <div style="color:#111; font-family:system-ui,sans-serif; font-size:13px; max-width:280px;">
            <div style="background:${riskColor}; color:#fff; padding:10px; border-radius:4px; text-align:center; font-weight:bold; margin-bottom:10px; font-size:12px;">
              ⚠️ ${riskLabel} FLOOD RISK
            </div>
            <strong style="color:#333; font-size:14px;">${f.properties.name}</strong><br>
            <div style="margin:8px 0; padding:8px; background:#f3f4f6; border-radius:4px;">
              <small style="color:#666; line-height:1.5;"><strong>Details:</strong> ${f.properties.details}</small>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
              <div style="padding:6px; background:#fef2f2; border-radius:4px;">
                <small style="color:#991b1b; font-weight:600; display:block; font-size:10px;">TYPICAL DEPTH</small>
                <small style="color:#7f1d1d; font-size:11px;">${f.properties.depth || 'Variable'}</small>
              </div>
              <div style="padding:6px; background:#fef2f2; border-radius:4px;">
                <small style="color:#991b1b; font-weight:600; display:block; font-size:10px;">FREQUENCY</small>
                <small style="color:#7f1d1d; font-size:11px;">${f.properties.frequency || 'Unknown'}</small>
              </div>
            </div>
            ${risk === 'critical' || risk === 'high' ? 
              '<div style="margin-top:10px; padding:8px; background:#fef2f2; border-left:3px solid #dc2626; font-size:11px; line-height:1.4;"><strong style="color:#dc2626;">⚠️ EVACUATION RECOMMENDED:</strong> This area experiences life-threatening flooding. Residents should evacuate during typhoon warnings.</div>' : 
              risk === 'moderate' ? 
              '<div style="margin-top:10px; padding:8px; background:#fffbeb; border-left:3px solid #f59e0b; font-size:11px; line-height:1.4;"><strong style="color:#d97706;">⚠️ CAUTION:</strong> Monitor weather conditions. Be prepared to evacuate if flooding worsens.</div>' :
              '<div style="margin-top:10px; padding:8px; background:#f0fdf4; border-left:3px solid #22c55e; font-size:11px; line-height:1.4;"><strong style="color:#16a34a;">ℹ️ LOW RISK:</strong> Generally safe, but stay alert during extreme weather.</div>'
            }
          </div>
        `)
        .addTo(map);
    });

    map.on('mouseenter', 'flood-risk-fill', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'flood-risk-fill', () => map.getCanvas().style.cursor = '');

    // Button wiring for zone filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => setFilter(btn.dataset.filter, btn));
    });

    // Toggle buttons for flood analysis
    let terrainEnabled = false;
    let buildingsEnabled = false;
    let floodVisible = false;
    let riverVisible = false;
    let contourVisible = false;

    document.getElementById('terrainBtn').addEventListener('click', function() {
      terrainEnabled = !terrainEnabled;
      
      if (terrainEnabled) {
        // Enable 3D terrain with exaggeration
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 3 });
        map.setLayoutProperty('hillshade', 'visibility', 'visible');
        
        // Adjust pitch for better 3D view
        map.easeTo({ pitch: 60, duration: 1000 });
        
        this.classList.add('active');
        this.textContent = 'Hide 3D Terrain Map';
      } else {
        // Disable terrain and return to flat view
        map.setTerrain(null);
        map.setLayoutProperty('hillshade', 'visibility', 'none');
        map.easeTo({ pitch: 0, duration: 1000 });
        
        this.classList.remove('active');
        this.textContent = 'Show 3D Terrain Map';
      }
    });

    document.getElementById('buildingsBtn').addEventListener('click', function() {
      buildingsEnabled = !buildingsEnabled;
      
      if (buildingsEnabled) {
        // Show 3D buildings and tilt camera
        map.setLayoutProperty('3d-buildings', 'visibility', 'visible');
        map.easeTo({ 
          pitch: 60, 
          bearing: -17.6,
          duration: 1000 
        });
        
        this.classList.add('active');
        this.textContent = 'Hide 3D Buildings';
      } else {
        // Hide buildings and return to top-down view
        map.setLayoutProperty('3d-buildings', 'visibility', 'none');
        map.easeTo({ 
          pitch: 0,
          bearing: 0,
          duration: 1000 
        });
        
        this.classList.remove('active');
        this.textContent = 'Show 3D Buildings';
      }
    });

    document.getElementById('floodBtn').addEventListener('click', function() {
      floodVisible = !floodVisible;
      const visibility = floodVisible ? 'visible' : 'none';
      
      map.setLayoutProperty('flood-risk-fill', 'visibility', visibility);
      map.setLayoutProperty('flood-risk-outline', 'visibility', visibility);
      
      this.classList.toggle('active');
      this.textContent = floodVisible ? 'Hide Flood Risk Zones' : 'Show Flood Risk Zones';
    });

    document.getElementById('riverBtn').addEventListener('click', function() {
      riverVisible = !riverVisible;
      const visibility = riverVisible ? 'visible' : 'none';
      
      // Toggle all water layers from Mapbox
      map.setLayoutProperty('mapbox-waterways', 'visibility', visibility);
      map.setLayoutProperty('mapbox-waterways-glow', 'visibility', visibility);
      map.setLayoutProperty('mapbox-water-bodies', 'visibility', visibility);
      
      this.classList.toggle('active');
      this.textContent = riverVisible ? 'Hide Water Bodies' : 'Show Water Bodies';
    });

    document.getElementById('contourBtn').addEventListener('click', function() {
      contourVisible = !contourVisible;
      
      if (contourVisible) {
        if (!map.getLayer('contours')) {
          map.addLayer({
            id: 'contours',
            type: 'line',
            source: {
              type: 'vector',
              url: 'mapbox://mapbox.mapbox-terrain-v2'
            },
            'source-layer': 'contour',
            paint: {
              'line-color': '#22c55e',
              'line-width': [
                'case',
                ['==', ['%', ['get', 'ele'], 10], 0],
                1.2,
                0.6
              ],
              'line-opacity': 0.5
            }
          });
        }
        map.setLayoutProperty('contours', 'visibility', 'visible');
        this.classList.add('active');
        this.textContent = 'Hide Elevation Lines';
      } else {
        if (map.getLayer('contours')) {
          map.setLayoutProperty('contours', 'visibility', 'none');
        }
        this.classList.remove('active');
        this.textContent = 'Show Elevation Lines';
      }
    });
  });

  function setFilter(type, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    if (type === 'all') {
      map.setFilter('zones-fill', null);
      map.setFilter('zones-outline', null);
      map.fitBounds(computeBoundsFromGeoJSON(currentData), { padding: 80, duration: 450 });
      return;
    }

    const key = `allows_${type}`;
    const filterExpr = ['==', ['get', key], true];

    map.setFilter('zones-fill', filterExpr);
    map.setFilter('zones-outline', filterExpr);

    const filtered = {
      type: "FeatureCollection",
      features: currentData.features.filter(f => f.properties && f.properties[key] === true)
    };

    if (filtered.features.length) {
      map.fitBounds(computeBoundsFromGeoJSON(filtered), { padding: 100, duration: 450 });
    }
  }
</script>

</body>
</html>