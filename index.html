<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ZoneGuide – Mandaue Flood Risk Analysis</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
  body { margin:0; padding:0; font-family:system-ui,sans-serif; background:#000; color:#fff; }
  #map { position:absolute; top:0; bottom:0; width:100%; }

  .controls{
    position:absolute; top:20px; left:20px;
    background:rgba(10,10,10,0.95);
    border:1px solid #333;
    padding:20px; width:280px; z-index:10;
    border-radius:8px;
  }
  .controls h3{
    margin:0 0 15px 0; font-size:14px; text-transform:uppercase; letter-spacing:1px;
    color:#888; border-bottom:1px solid #333; padding-bottom:10px;
  }
  .filter-btn{
    display:block; width:100%;
    padding:12px; margin-bottom:8px;
    background:transparent; border:1px solid #444;
    color:#ccc; cursor:pointer; font-size:13px; text-align:left; text-transform:uppercase;
    border-radius:4px; transition:all 0.2s;
  }
  .filter-btn:hover{ border-color:#fff; color:#fff; }
  .filter-btn.active{ background:#fff; color:#000; border-color:#fff; font-weight:bold; }

  .legend{
    position:absolute; bottom:30px; right:20px;
    background:rgba(0,0,0,0.9);
    border:1px solid #333;
    padding:15px; font-size:12px;
    border-radius:8px;
  }
  .legend h4{
    margin:0 0 10px 0; font-size:12px; text-transform:uppercase; 
    color:#888; border-bottom:1px solid #333; padding-bottom:8px;
  }
  .legend-item{ display:flex; align-items:center; margin-bottom:8px; }
  .color-box{ width:14px; height:14px; margin-right:10px; border:1px solid #555; border-radius:2px; }

  .elevation-controls{
    position:absolute; top:20px; right:20px;
    background:rgba(10,10,10,0.95);
    border:1px solid #333;
    padding:15px; width:240px; z-index:10;
    border-radius:8px;
  }
  .elevation-controls h3{
    margin:0 0 10px 0; font-size:13px; text-transform:uppercase; letter-spacing:1px;
    color:#888; border-bottom:1px solid #333; padding-bottom:8px;
  }
  .toggle-btn{
    display:block; width:100%;
    padding:10px; margin-bottom:8px;
    background:transparent; border:1px solid #444;
    color:#ccc; cursor:pointer; font-size:12px; text-align:center;
    border-radius:4px; transition:all 0.2s;
  }
  .toggle-btn:hover{ border-color:#fff; color:#fff; }
  .toggle-btn.active{ background:#ef4444; color:#fff; border-color:#ef4444; font-weight:bold; }
</style>
</head>

<body>
<div id="map"></div>

<div class="controls">
  <h3>Project Filter</h3>
  <button class="filter-btn active" data-filter="all">View All Zones</button>
  <button class="filter-btn" data-filter="house">Residential Project</button>
  <button class="filter-btn" data-filter="factory">Industrial Facility</button>
  <button class="filter-btn" data-filter="mall">Commercial Complex</button>
</div>

<div class="legend">
  <h4>Zoning Districts</h4>
  <div class="legend-item"><span class="color-box" style="background:#facc15"></span>Residential (R-1)</div>
  <div class="legend-item"><span class="color-box" style="background:#a855f7"></span>Industrial (I-2)</div>
  <div class="legend-item"><span class="color-box" style="background:#ef4444"></span>Commercial (C-2)</div>
  
  <h4 style="margin-top:15px;">Flood Risk Zones</h4>
  <div class="legend-item"><span class="color-box" style="background:#dc2626"></span>High Risk (Red)</div>
  <div class="legend-item"><span class="color-box" style="background:#f59e0b"></span>Moderate Risk (Orange)</div>
  <div class="legend-item"><span class="color-box" style="background:#fbbf24"></span>Low Risk (Yellow)</div>
</div>

<div class="elevation-controls">
  <h3>Flood Risk Layers</h3>
  <button class="toggle-btn" id="terrainBtn">Show 3D Terrain Map</button>
  <button class="toggle-btn" id="floodBtn">Show Flood Risk Zones</button>
  <button class="toggle-btn" id="riverBtn">Show Butuanon River</button>
  <button class="toggle-btn" id="contourBtn">Show Elevation Lines</button>
  <div style="margin-top:12px; font-size:11px; color:#888; line-height:1.5;">
    <strong style="color:#3b82f6;">3D Terrain:</strong> Shows actual elevation with hillshading<br><br>
    <strong style="color:#ef4444;">High risk areas:</strong> Near Butuanon River, low elevation, poor drainage<br><br>
    <em>Based on actual flood incidents in Mandaue barangays</em>
  </div>
</div>

<script>
  mapboxgl.accessToken =
  'pk.eyJ1IjoiZmxhcmVpdW0iLCJhIjoiY21qaXF4eDRyMTQ5ZjNlcTF2c3Ntd3NzOSJ9.jb1Fbw5JUyvBJ2czkccBXA';

  // Updated zones with realistic flood risk based on Butuanon River proximity
  const zoningData = {
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        properties: {
          name: "Cabancalan–Canduman Residential Area",
          zone: "Residential (R-1)",
          color: "#facc15",
          allows_house: true,
          allows_mall: false,
          allows_factory: false,
          notes: "Predominantly residential barangays with low-rise housing.",
          floodRisk: "moderate"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.920, 10.360],
            [123.930, 10.365],
            [123.938, 10.362],
            [123.945, 10.355],
            [123.942, 10.345],
            [123.935, 10.342],
            [123.925, 10.345],
            [123.918, 10.352],
            [123.920, 10.360]
          ]]
        }
      },
      {
        type: "Feature",
        properties: {
          name: "A.S. Fortuna – Banilad Commercial Corridor",
          zone: "Commercial (C-2)",
          color: "#ef4444",
          allows_house: true,
          allows_mall: true,
          allows_factory: false,
          notes: "Dense commercial corridor along A.S. Fortuna Street. Prone to flooding during heavy rains.",
          floodRisk: "high"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.915, 10.348],
            [123.928, 10.350],
            [123.935, 10.345],
            [123.930, 10.335],
            [123.922, 10.332],
            [123.912, 10.335],
            [123.910, 10.342],
            [123.915, 10.348]
          ]]
        }
      },
      {
        type: "Feature",
        properties: {
          name: "Subangdaku Industrial Belt",
          zone: "Industrial (I-2)",
          color: "#a855f7",
          allows_house: false,
          allows_mall: true,
          allows_factory: true,
          notes: "Industrial zone in central-western Mandaue. High flood risk from Butuanon River overflow.",
          floodRisk: "high"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [123.918, 10.330],
            [123.933, 10.332],
            [123.938, 10.325],
            [123.936, 10.315],
            [123.930, 10.310],
            [123.920, 10.308],
            [123.912, 10.312],
            [123.910, 10.320],
            [123.915, 10.328],
            [123.918, 10.330]
          ]]
        }
      }
    ]
  };

  // Butuanon River path - ACCURATE based on official barangay documentation
  // TRUE SOURCE: Mountain areas of Malubog/Pulangbato → Talamban (Cebu City) → 
  // flows into Mandaue through: Banilad → Cabancalan → Casuntingan → 
  // Tingub → Maguikay → Tabok → Ibabao → Alang-alang → Paknaan → Umapad → Mactan Channel
  const butuanonRiver = {
    type: "Feature",
    properties: { name: "Butuanon River - 23km from mountains to sea" },
    geometry: {
      type: "LineString",
      coordinates: [
        // TRUE UPSTREAM: Mountain area (Malubog/Pulangbato area, Cebu City)
        [123.885, 10.380],
        [123.890, 10.378],
        // Pulangbato area (documented flooding/riprap damage)
        [123.895, 10.375],
        [123.900, 10.372],
        // Talamban area (primary watershed)
        [123.905, 10.370],
        [123.910, 10.368],
        [123.913, 10.366],
        // Bacayan-Banilad border (Cebu City to Mandaue transition)
        [123.916, 10.364],
        [123.918, 10.362],
        // MANDAUE CITY BEGINS - Banilad area
        [123.920, 10.360],
        [123.923, 10.358],
        // Cabancalan-Canduman area
        [123.925, 10.355],
        [123.927, 10.350],
        // Casuntingan area (damaged riprap documented here)
        [123.928, 10.345],
        [123.929, 10.340],
        // Tingub-Maguikay
        [123.930, 10.335],
        [123.930, 10.330],
        // Tabok area (footbridge)
        [123.929, 10.325],
        // Ibabao-Estancia (major flood area)
        [123.928, 10.320],
        [123.927, 10.315],
        // Alang-alang
        [123.926, 10.310],
        // Paknaan (Cambogaong Bridge, Butuanon Bridge, viewing deck)
        [123.925, 10.305],
        [123.924, 10.300],
        // Umapad area (major flooding, UN Avenue affected)
        [123.923, 10.295],
        // Drains to Mactan Channel (river mouth near Magellan Bay)
        [123.922, 10.290],
        [123.920, 10.285],
        [123.918, 10.280]
      ]
    }
  };

  // Flood risk zones - LOGICAL buffer zones along the actual river path
  // Creates narrow corridors along the Butuanon River where flooding actually occurs
  const floodRiskZones = {
    type: "FeatureCollection",
    features: [
      // HIGH RISK: 200m buffer zone directly along river (most critical)
      {
        type: "Feature",
        properties: { 
          risk: "high", 
          name: "Critical Flood Zone: River Banks (0-200m)",
          details: "Immediate riverbank areas - severe flooding, water reaches 2nd floor"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            // Left bank (west side) - tight to river from mountains to sea
            [123.883, 10.380],
            [123.888, 10.378],
            [123.893, 10.375],
            [123.898, 10.372],
            [123.903, 10.370],
            [123.908, 10.368],
            [123.911, 10.366],
            [123.914, 10.364],
            [123.916, 10.362],
            [123.918, 10.360],
            [123.921, 10.358],
            [123.923, 10.355],
            [123.925, 10.350],
            [123.926, 10.345],
            [123.927, 10.340],
            [123.928, 10.335],
            [123.928, 10.330],
            [123.927, 10.325],
            [123.926, 10.320],
            [123.925, 10.315],
            [123.924, 10.310],
            [123.923, 10.305],
            [123.922, 10.300],
            [123.921, 10.295],
            [123.920, 10.290],
            [123.918, 10.285],
            [123.916, 10.280],
            // Right bank (east side) - creates corridor
            [123.920, 10.280],
            [123.922, 10.285],
            [123.924, 10.290],
            [123.925, 10.295],
            [123.926, 10.300],
            [123.927, 10.305],
            [123.928, 10.310],
            [123.929, 10.315],
            [123.930, 10.320],
            [123.931, 10.325],
            [123.932, 10.330],
            [123.932, 10.335],
            [123.933, 10.340],
            [123.932, 10.345],
            [123.931, 10.350],
            [123.930, 10.355],
            [123.929, 10.358],
            [123.927, 10.360],
            [123.925, 10.362],
            [123.922, 10.364],
            [123.919, 10.366],
            [123.915, 10.368],
            [123.912, 10.370],
            [123.907, 10.372],
            [123.902, 10.375],
            [123.897, 10.378],
            [123.892, 10.380],
            [123.887, 10.380],
            [123.883, 10.380]
          ]]
        }
      },
      // MODERATE RISK: 200-400m buffer from river (west side)
      {
        type: "Feature",
        properties: { 
          risk: "moderate", 
          name: "Moderate Flood Zone: West Bank (200-400m)",
          details: "Secondary flooding from overflow, waist to chest deep water"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            // Outer left bank
            [123.880, 10.380],
            [123.885, 10.378],
            [123.890, 10.375],
            [123.895, 10.372],
            [123.900, 10.370],
            [123.905, 10.368],
            [123.908, 10.366],
            [123.911, 10.364],
            [123.913, 10.362],
            [123.915, 10.360],
            [123.918, 10.358],
            [123.920, 10.355],
            [123.922, 10.350],
            [123.923, 10.345],
            [123.924, 10.340],
            [123.925, 10.335],
            [123.925, 10.330],
            [123.924, 10.325],
            [123.923, 10.320],
            [123.922, 10.315],
            [123.921, 10.310],
            [123.920, 10.305],
            [123.919, 10.300],
            [123.918, 10.295],
            [123.917, 10.290],
            [123.915, 10.285],
            [123.913, 10.280],
            // Inner boundary (connects to high risk zone)
            [123.916, 10.280],
            [123.918, 10.285],
            [123.920, 10.290],
            [123.921, 10.295],
            [123.922, 10.300],
            [123.923, 10.305],
            [123.924, 10.310],
            [123.925, 10.315],
            [123.926, 10.320],
            [123.927, 10.325],
            [123.928, 10.330],
            [123.928, 10.335],
            [123.927, 10.340],
            [123.926, 10.345],
            [123.925, 10.350],
            [123.923, 10.355],
            [123.921, 10.358],
            [123.918, 10.360],
            [123.916, 10.362],
            [123.914, 10.364],
            [123.911, 10.366],
            [123.908, 10.368],
            [123.903, 10.370],
            [123.898, 10.372],
            [123.893, 10.375],
            [123.888, 10.378],
            [123.883, 10.380],
            [123.880, 10.380]
          ]]
        }
      },
      // MODERATE RISK: East side buffer
      {
        type: "Feature",
        properties: { 
          risk: "moderate", 
          name: "Moderate Flood Zone: East Bank (200-400m)",
          details: "Secondary flooding from overflow"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            // Inner boundary (high risk zone edge)
            [123.920, 10.280],
            [123.922, 10.285],
            [123.924, 10.290],
            [123.925, 10.295],
            [123.926, 10.300],
            [123.927, 10.305],
            [123.928, 10.310],
            [123.929, 10.315],
            [123.930, 10.320],
            [123.931, 10.325],
            [123.932, 10.330],
            [123.932, 10.335],
            [123.933, 10.340],
            [123.932, 10.345],
            [123.931, 10.350],
            [123.930, 10.355],
            [123.929, 10.358],
            [123.927, 10.360],
            [123.925, 10.362],
            [123.922, 10.364],
            [123.919, 10.366],
            [123.915, 10.368],
            [123.912, 10.370],
            [123.907, 10.372],
            [123.902, 10.375],
            [123.897, 10.378],
            [123.892, 10.380],
            // Outer boundary
            [123.895, 10.380],
            [123.900, 10.378],
            [123.905, 10.375],
            [123.910, 10.372],
            [123.915, 10.370],
            [123.918, 10.368],
            [123.922, 10.366],
            [123.925, 10.364],
            [123.928, 10.362],
            [123.930, 10.360],
            [123.932, 10.358],
            [123.933, 10.355],
            [123.934, 10.350],
            [123.935, 10.345],
            [123.936, 10.340],
            [123.936, 10.335],
            [123.935, 10.330],
            [123.934, 10.325],
            [123.933, 10.320],
            [123.932, 10.315],
            [123.931, 10.310],
            [123.930, 10.305],
            [123.929, 10.300],
            [123.928, 10.295],
            [123.927, 10.290],
            [123.925, 10.285],
            [123.923, 10.280],
            [123.920, 10.280]
          ]]
        }
      },
      // LOW RISK: 400-600m buffer west side
      {
        type: "Feature",
        properties: { 
          risk: "low", 
          name: "Low Flood Zone: Extended West Buffer (400-600m)",
          details: "Occasional minor flooding during extreme weather"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            // Far left boundary
            [123.877, 10.380],
            [123.882, 10.378],
            [123.887, 10.375],
            [123.892, 10.372],
            [123.897, 10.370],
            [123.902, 10.368],
            [123.905, 10.366],
            [123.908, 10.364],
            [123.910, 10.362],
            [123.912, 10.360],
            [123.915, 10.358],
            [123.917, 10.355],
            [123.919, 10.350],
            [123.920, 10.345],
            [123.921, 10.340],
            [123.922, 10.335],
            [123.922, 10.330],
            [123.921, 10.325],
            [123.920, 10.320],
            [123.919, 10.315],
            [123.918, 10.310],
            [123.917, 10.305],
            [123.916, 10.300],
            [123.915, 10.295],
            [123.914, 10.290],
            [123.912, 10.285],
            [123.910, 10.280],
            // Inner boundary (moderate zone)
            [123.913, 10.280],
            [123.915, 10.285],
            [123.917, 10.290],
            [123.918, 10.295],
            [123.919, 10.300],
            [123.920, 10.305],
            [123.921, 10.310],
            [123.922, 10.315],
            [123.923, 10.320],
            [123.924, 10.325],
            [123.925, 10.330],
            [123.925, 10.335],
            [123.924, 10.340],
            [123.923, 10.345],
            [123.922, 10.350],
            [123.920, 10.355],
            [123.918, 10.358],
            [123.915, 10.360],
            [123.913, 10.362],
            [123.911, 10.364],
            [123.908, 10.366],
            [123.905, 10.368],
            [123.900, 10.370],
            [123.895, 10.372],
            [123.890, 10.375],
            [123.885, 10.378],
            [123.880, 10.380],
            [123.877, 10.380]
          ]]
        }
      },
      // LOW RISK: East far buffer
      {
        type: "Feature",
        properties: { 
          risk: "low", 
          name: "Low Flood Zone: East Extended (400-600m)",
          details: "Minimal flood risk, occasional street flooding"
        },
        geometry: {
          type: "Polygon",
          coordinates: [[
            // Inner (moderate zone edge)
            [123.923, 10.280],
            [123.925, 10.285],
            [123.927, 10.290],
            [123.928, 10.295],
            [123.929, 10.300],
            [123.930, 10.305],
            [123.931, 10.310],
            [123.932, 10.315],
            [123.933, 10.320],
            [123.934, 10.325],
            [123.935, 10.330],
            [123.936, 10.335],
            [123.936, 10.340],
            [123.935, 10.345],
            [123.934, 10.350],
            [123.933, 10.355],
            [123.932, 10.358],
            [123.930, 10.360],
            [123.928, 10.362],
            [123.925, 10.364],
            [123.922, 10.366],
            [123.918, 10.368],
            [123.915, 10.370],
            [123.910, 10.372],
            [123.905, 10.375],
            [123.900, 10.378],
            [123.895, 10.380],
            // Outer boundary
            [123.898, 10.380],
            [123.903, 10.378],
            [123.908, 10.375],
            [123.913, 10.372],
            [123.918, 10.370],
            [123.921, 10.368],
            [123.925, 10.366],
            [123.928, 10.364],
            [123.931, 10.362],
            [123.933, 10.360],
            [123.935, 10.358],
            [123.936, 10.355],
            [123.937, 10.350],
            [123.938, 10.345],
            [123.939, 10.340],
            [123.939, 10.335],
            [123.938, 10.330],
            [123.937, 10.325],
            [123.936, 10.320],
            [123.935, 10.315],
            [123.934, 10.310],
            [123.933, 10.305],
            [123.932, 10.300],
            [123.931, 10.295],
            [123.930, 10.290],
            [123.928, 10.285],
            [123.926, 10.280],
            [123.923, 10.280]
          ]]
        }
      }
    ]
  };

  let currentData = JSON.parse(JSON.stringify(zoningData));

  function computeBoundsFromGeoJSON(fc) {
    const bounds = new mapboxgl.LngLatBounds();
    fc.features.forEach(f => {
      const coords = f.geometry.coordinates[0];
      coords.forEach(([lng, lat]) => bounds.extend([lng, lat]));
    });
    return bounds;
  }

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [123.93, 10.33],
    zoom: 12.5
  });

  map.on('load', () => {
    // Add terrain source for 3D elevation
    map.addSource('mapbox-dem', {
      type: 'raster-dem',
      url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
      tileSize: 512,
      maxzoom: 14
    });

    // Add hillshade layer for terrain visualization
    map.addLayer({
      id: 'hillshade',
      type: 'hillshade',
      source: 'mapbox-dem',
      layout: { visibility: 'none' },
      paint: {
        'hillshade-exaggeration': 1.5,
        'hillshade-shadow-color': '#000000',
        'hillshade-highlight-color': '#ffffff',
        'hillshade-illumination-direction': 315
      }
    }, 'flood-risk-fill');

    // Add flood risk zones layer (initially hidden)
    map.addSource('flood-risk', {
      type: 'geojson',
      data: floodRiskZones
    });

    map.addLayer({
      id: 'flood-risk-fill',
      type: 'fill',
      source: 'flood-risk',
      layout: { visibility: 'none' },
      paint: {
        'fill-color': [
          'match',
          ['get', 'risk'],
          'high', '#dc2626',
          'moderate', '#f59e0b',
          'low', '#fbbf24',
          '#888888'
        ],
        'fill-opacity': 0.4
      }
    });

    map.addLayer({
      id: 'flood-risk-outline',
      type: 'line',
      source: 'flood-risk',
      layout: { visibility: 'none' },
      paint: {
        'line-color': [
          'match',
          ['get', 'risk'],
          'high', '#dc2626',
          'moderate', '#f59e0b',
          'low', '#fbbf24',
          '#888888'
        ],
        'line-width': 1,
        'line-opacity': 0.6
      }
    });

    // Add Butuanon River layer (initially hidden)
    map.addSource('butuanon-river', {
      type: 'geojson',
      data: butuanonRiver
    });

    map.addLayer({
      id: 'river-line',
      type: 'line',
      source: 'butuanon-river',
      layout: { visibility: 'none' },
      paint: {
        'line-color': '#1e40af',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          11, 3,    // At zoom 11, river is 3px (smaller view)
          13, 8,    // At zoom 13, river is 8px (medium view)
          15, 16,   // At zoom 15, river is 16px (closer view - shows ~15-20m width)
          17, 32    // At zoom 17, river is 32px (very close - shows full width)
        ],
        'line-opacity': 0.85
      }
    });

    map.addLayer({
      id: 'river-glow',
      type: 'line',
      source: 'butuanon-river',
      layout: { visibility: 'none' },
      paint: {
        'line-color': '#3b82f6',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          11, 8,
          13, 20,
          15, 40,
          17, 60
        ],
        'line-opacity': 0.25,
        'line-blur': 8
      }
    });

    // Add zoning layers
    map.addSource('zones', { type: 'geojson', data: currentData });

    map.addLayer({
      id: 'zones-fill',
      type: 'fill',
      source: 'zones',
      paint: {
        'fill-color': ['get', 'color'],
        'fill-opacity': 0.5
      }
    });

    map.addLayer({
      id: 'zones-outline',
      type: 'line',
      source: 'zones',
      paint: {
        'line-color': '#ffffff',
        'line-width': 2,
        'line-opacity': 0.6
      }
    });

    // Cursor UX
    map.on('mouseenter', 'zones-fill', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'zones-fill', () => map.getCanvas().style.cursor = '');

    // Fit to zones on load
    map.fitBounds(computeBoundsFromGeoJSON(currentData), { padding: 80, duration: 0 });

    // Click popup for zones
    map.on('click', 'zones-fill', (e) => {
      const f = e.features && e.features[0];
      if (!f) return;

      const p = f.properties || {};
      const name = p.name ?? "Unnamed Zone";
      const zone = p.zone ?? "Unknown Zone";
      const notes = p.notes ?? "";
      const floodRisk = p.floodRisk ?? "unknown";
      
      const riskColor = floodRisk === 'high' ? '#dc2626' : 
                        floodRisk === 'moderate' ? '#f59e0b' : '#22c55e';
      const riskText = floodRisk === 'high' ? 'HIGH RISK' : 
                       floodRisk === 'moderate' ? 'MODERATE RISK' : 'LOW RISK';

      new mapboxgl.Popup({ closeButton: true, closeOnClick: true })
        .setLngLat(e.lngLat)
        .setHTML(`
          <div style="color:#111; font-family:system-ui,sans-serif; font-size:13px;">
            <strong>${name}</strong><br>
            <span style="color:#666;">Zone: ${zone}</span><br>
            <div style="margin:8px 0; padding:6px; background:${riskColor}; color:#fff; border-radius:4px; text-align:center; font-weight:bold; font-size:11px;">
              FLOOD RISK: ${riskText}
            </div>
            <small style="color:#666;">${notes}</small>
          </div>
        `)
        .addTo(map);
    });

    // Click popup for flood zones
    map.on('click', 'flood-risk-fill', (e) => {
      const f = e.features && e.features[0];
      if (!f) return;

      const risk = f.properties.risk;
      const riskColor = risk === 'high' ? '#dc2626' : 
                        risk === 'moderate' ? '#f59e0b' : '#fbbf24';

      new mapboxgl.Popup({ closeButton: true, closeOnClick: true })
        .setLngLat(e.lngLat)
        .setHTML(`
          <div style="color:#111; font-family:system-ui,sans-serif; font-size:13px; max-width:250px;">
            <div style="background:${riskColor}; color:#fff; padding:8px; border-radius:4px; text-align:center; font-weight:bold; margin-bottom:8px;">
              ${risk.toUpperCase()} FLOOD RISK
            </div>
            <strong style="color:#333;">${f.properties.name}</strong><br>
            <small style="color:#666; line-height:1.4;">${f.properties.details}</small>
            ${risk === 'high' ? '<div style="margin-top:8px; padding:6px; background:#fef2f2; border-left:3px solid #dc2626; font-size:11px;"><strong style="color:#dc2626;">⚠️ Warning:</strong> This area experiences severe flooding during typhoons. Water can reach 2nd floor or roof level.</div>' : ''}
          </div>
        `)
        .addTo(map);
    });

    map.on('mouseenter', 'flood-risk-fill', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'flood-risk-fill', () => map.getCanvas().style.cursor = '');

    // Button wiring for zone filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => setFilter(btn.dataset.filter, btn));
    });

    // Toggle buttons for flood analysis
    let terrainEnabled = false;
    let floodVisible = false;
    let riverVisible = false;
    let contourVisible = false;

    document.getElementById('terrainBtn').addEventListener('click', function() {
      terrainEnabled = !terrainEnabled;
      
      if (terrainEnabled) {
        // Enable 3D terrain with exaggeration
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 3 });
        map.setLayoutProperty('hillshade', 'visibility', 'visible');
        
        // Adjust pitch for better 3D view
        map.easeTo({ pitch: 60, duration: 1000 });
        
        this.classList.add('active');
        this.textContent = 'Hide 3D Terrain Map';
      } else {
        // Disable terrain and return to flat view
        map.setTerrain(null);
        map.setLayoutProperty('hillshade', 'visibility', 'none');
        map.easeTo({ pitch: 0, duration: 1000 });
        
        this.classList.remove('active');
        this.textContent = 'Show 3D Terrain Map';
      }
    });

    document.getElementById('floodBtn').addEventListener('click', function() {
      floodVisible = !floodVisible;
      const visibility = floodVisible ? 'visible' : 'none';
      
      map.setLayoutProperty('flood-risk-fill', 'visibility', visibility);
      map.setLayoutProperty('flood-risk-outline', 'visibility', visibility);
      
      this.classList.toggle('active');
      this.textContent = floodVisible ? 'Hide Flood Risk Zones' : 'Show Flood Risk Zones';
    });

    document.getElementById('riverBtn').addEventListener('click', function() {
      riverVisible = !riverVisible;
      const visibility = riverVisible ? 'visible' : 'none';
      
      map.setLayoutProperty('river-line', 'visibility', visibility);
      map.setLayoutProperty('river-glow', 'visibility', visibility);
      
      this.classList.toggle('active');
      this.textContent = riverVisible ? 'Hide Butuanon River' : 'Show Butuanon River';
    });

    document.getElementById('contourBtn').addEventListener('click', function() {
      contourVisible = !contourVisible;
      
      if (contourVisible) {
        if (!map.getLayer('contours')) {
          map.addLayer({
            id: 'contours',
            type: 'line',
            source: {
              type: 'vector',
              url: 'mapbox://mapbox.mapbox-terrain-v2'
            },
            'source-layer': 'contour',
            paint: {
              'line-color': '#22c55e',
              'line-width': [
                'case',
                ['==', ['%', ['get', 'ele'], 10], 0],
                1.2,
                0.6
              ],
              'line-opacity': 0.5
            }
          });
        }
        map.setLayoutProperty('contours', 'visibility', 'visible');
        this.classList.add('active');
        this.textContent = 'Hide Elevation Lines';
      } else {
        if (map.getLayer('contours')) {
          map.setLayoutProperty('contours', 'visibility', 'none');
        }
        this.classList.remove('active');
        this.textContent = 'Show Elevation Lines';
      }
    });
  });

  function setFilter(type, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    if (type === 'all') {
      map.setFilter('zones-fill', null);
      map.setFilter('zones-outline', null);
      map.fitBounds(computeBoundsFromGeoJSON(currentData), { padding: 80, duration: 450 });
      return;
    }

    const key = `allows_${type}`;
    const filterExpr = ['==', ['get', key], true];

    map.setFilter('zones-fill', filterExpr);
    map.setFilter('zones-outline', filterExpr);

    const filtered = {
      type: "FeatureCollection",
      features: currentData.features.filter(f => f.properties && f.properties[key] === true)
    };

    if (filtered.features.length) {
      map.fitBounds(computeBoundsFromGeoJSON(filtered), { padding: 100, duration: 450 });
    }
  }
</script>

</body>
</html>